import numpy as np
from sklearn.metrics.pairwise import cosine_similarity, cosine_distances
from scipy.spatial.distance import cosine


def similarity(i, j):
    """
    Calculates similarity between two items.
    :param i: First item (one-hot vector).
    :param j: Second item (one-hot vector).
    :return: Number from [0, 1], where 0 means items are completely different, 1 items are the same.
    """
    # return (cosine_similarity([i], [j])[0] + 1) / 2  # map range from [-1, 1] to [0, 1]
    res = 1 - cosine(i, j)
    return res if not np.isnan(res) else 0


def distance(i, j):
    """
    Calculates distance between two items.
    :param i: First item (one-hot vector).
    :param j: Second item (one-hot vector).
    :return: Number from [0, 1], where 0 means items are the same, 1 items are completely different.
    """
    return 1 - similarity(i, j)


def novelty(recommendations, user_profile, mode=np.mean):
    """
    Calculates novelty of recommendation for user with profile `user_profile`.
    :param recommendations: Recommendations as embeddings.
    :param user_profile: User profile.
    :param mode: Aggregation function.
    :return: Number from [0, 1], where 0 means items aren't novel, 1 items are novel.
    """
    return mode(cosine_distances(recommendations, user_profile), axis=1)


def unexpectedness(recommendations, primitive_recommendations):
    return np.array([~np.isin(recommendations, primitive_recommendations)]).mean()


def relevance(recommendations, user_profile, mode=np.mean):
    """
    Calculates relevance of recommendation for user with profile `user_profile`.
    :param recommendations: Recommendations as embeddings.
    :param user_profile: User profile.
    :param mode: Aggregation function.
    :return: Number from [0, 1], where 0 means items aren't relevant, 1 items are relevant.
    """
    return mode(cosine_similarity(recommendations, user_profile), axis=1)


# TODO coefs
def serendipity(items, recommendations, primitive_recommendations, user_profile,
                alpha=0.3, beta=0.4, gamma=0.3, keepdims=False, verbose=False):
    """
    Serendipity of recommendation list.

    :param items: Recommended items as one-hot encoded vectors.
    :param recommendations: Recommendation's id list.
    :param primitive_recommendations: Primitive recommendation's id list (generated by simple algorithm).
    :param user_profile: One-hot encoded vectors of user's rated items.
    :param alpha: Weight of novelty.
    :param beta: Weight of unexpectedness.
    :param gamma: Weight of relevance.
    :param keepdims: Return score for each entry when True, return mean score otherwise.
    :param verbose: Print intermediate results if set to True, doesn't otherwise.
    :return: A number from [0, 1] interval. 1 is a maximum, 0 is a minimum.
    """
    assert alpha + beta + gamma == 1, 'The sum of coefficients isn\'t equal to 1'

    _novelty = alpha * novelty(items, user_profile) if alpha > 0.0 else 0.0
    _unexpectedness = beta * unexpectedness(recommendations, primitive_recommendations) if beta > 0.0 else 0.0
    _relevance = gamma * relevance(items, user_profile) if gamma > 0.0 else 0.0

    if verbose:
        print('Novelty: {}, relevance: {}, unexp: {}'.format(_novelty, _relevance, _unexpectedness))

    if keepdims:
        return _novelty + _relevance + np.mean(_unexpectedness)
    else:
        return np.mean(np.mean(_novelty) + np.mean(_relevance) + np.mean(_unexpectedness))
